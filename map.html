<!DOCTYPE html>
<html>
  <head>
    <style>
       #map {
        height: 800px;
        width: 100%;
       }
    </style>
    <title>FollowMe</title>
  </head>
  <body>
    <h3>FollowMe<h3>
    <div id="map"></div>
    <script>
      var target;
      var vehicle;
      var map;
      var quad;

      function handle_new_position () {
        data = JSON.parse(this.responseText);
        v = data.vehicle
        t = data.target
        quad.rotation = v.bearing;
        vehicle.setIcon(quad);
        vehicle.setPosition({lat: v.lat, lng: v.lon});
        target.setPosition({lat: t.lat, lng: t.lon});
        map.setCenter({lat: t.lat, lng: t.lon})
      }

      function update_position() {
        var req = new XMLHttpRequest();

        req.addEventListener('load', handle_new_position);
        req.open('GET', '/position');
        req.send();
      }

      function start_tracking() {
        setInterval(update_position, 100);
      }

      function initMap() {
        var pos;

        quad = {
            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
            scale: 10,
        };

        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 20,
        });

        target = new google.maps.Marker({map: map, label: 'T'});
        vehicle = new google.maps.Marker({
          map: map,
          label: 'V',
          icon: quad
        });

        navigator.geolocation.getCurrentPosition(function(position) {
          pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          map.setCenter(pos);
          start_tracking();
        });

      }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAbzBsbnApy8arPHuBBrmk17R6geR_Hh5g&callback=initMap">
    </script>
  </body>
</html>
